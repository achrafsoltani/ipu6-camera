#!/usr/bin/env python3
# ==============================================================================
# IPU6 Camera Tray Toggle Utility
# ==============================================================================
#
# System tray applet for toggling the IPU6 camera service on/off.
# Uses AyatanaAppIndicator3 for reliable tray icon on modern GNOME/Wayland.
#
# Dependencies: gir1.2-ayatanaappindicator3-0.1, python3-gi
#
# Usage:
#   ipu6-camera-tray        (runs with tray icon)
#
# ==============================================================================

import subprocess
import sys
import os
import fcntl
import re

import gi
gi.require_version("Gtk", "3.0")
gi.require_version("AyatanaAppIndicator3", "0.1")
from gi.repository import Gtk, GLib, AyatanaAppIndicator3

SERVICE = "ipu6-camera-loopback"
SERVICE_FILE = f"/etc/systemd/system/{SERVICE}.service"
ICON_ON = "camera-video"
ICON_OFF = "camera-video-symbolic"
LOCK_PATH = "/tmp/ipu6-camera-tray.lock"


def run(cmd):
    """Run a command and return (returncode, stdout)."""
    r = subprocess.run(cmd, capture_output=True, text=True)
    return r.returncode, r.stdout.strip()


def is_active():
    rc, _ = run(["systemctl", "is-active", "--quiet", SERVICE])
    return rc == 0


def is_enabled():
    rc, _ = run(["systemctl", "is-enabled", "--quiet", SERVICE])
    return rc == 0


def get_current_resolution():
    try:
        with open(SERVICE_FILE) as f:
            content = f.read()
        m = re.search(r"width=(\d+)", content)
        if m and m.group(1) == "1920":
            return "1080p"
        return "720p"
    except OSError:
        return "720p"


class CameraTray:
    def __init__(self):
        self.indicator = AyatanaAppIndicator3.Indicator.new(
            "ipu6-camera-tray",
            ICON_OFF,
            AyatanaAppIndicator3.IndicatorCategory.HARDWARE,
        )
        self.indicator.set_status(AyatanaAppIndicator3.IndicatorStatus.ACTIVE)
        self.indicator.set_menu(self._build_menu())
        self._update_icon()
        GLib.timeout_add_seconds(5, self._poll)

    def _build_menu(self):
        menu = Gtk.Menu()

        self.toggle_item = Gtk.MenuItem(label="Toggle Camera")
        self.toggle_item.connect("activate", self._on_toggle)
        menu.append(self.toggle_item)

        menu.append(Gtk.SeparatorMenuItem())

        settings_item = Gtk.MenuItem(label="Settings\u2026")
        settings_item.connect("activate", self._on_settings)
        menu.append(settings_item)

        status_item = Gtk.MenuItem(label="Status\u2026")
        status_item.connect("activate", self._on_status)
        menu.append(status_item)

        menu.append(Gtk.SeparatorMenuItem())

        quit_item = Gtk.MenuItem(label="Quit")
        quit_item.connect("activate", self._on_quit)
        menu.append(quit_item)

        menu.show_all()
        return menu

    def _update_icon(self):
        if is_active():
            self.indicator.set_icon_full(ICON_ON, "Camera Active")
            self.toggle_item.set_label("Turn Camera Off")
        else:
            self.indicator.set_icon_full(ICON_OFF, "Camera Inactive")
            self.toggle_item.set_label("Turn Camera On")

    def _poll(self):
        self._update_icon()
        return True

    def _on_toggle(self, _):
        action = "stop" if is_active() else "start"
        subprocess.Popen(["pkexec", "systemctl", action, SERVICE])
        GLib.timeout_add(2000, self._update_icon)

    def _on_settings(self, _):
        current_res = get_current_resolution()
        autostart = is_enabled()

        dialog = Gtk.Dialog(
            title="IPU6 Camera Settings",
            flags=Gtk.DialogFlags.MODAL,
        )
        dialog.add_buttons(
            Gtk.STOCK_CANCEL, Gtk.ResponseType.CANCEL,
            Gtk.STOCK_OK, Gtk.ResponseType.OK,
        )
        dialog.set_default_size(350, -1)
        dialog.set_icon_name(ICON_ON)

        box = dialog.get_content_area()
        box.set_spacing(12)
        box.set_margin_start(16)
        box.set_margin_end(16)
        box.set_margin_top(12)
        box.set_margin_bottom(8)

        # Resolution
        res_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=12)
        res_box.pack_start(Gtk.Label(label="Resolution:"), False, False, 0)
        res_combo = Gtk.ComboBoxText()
        res_combo.append_text("720p (1280\u00d7720)")
        res_combo.append_text("1080p (1920\u00d71080)")
        res_combo.set_active(1 if current_res == "1080p" else 0)
        res_box.pack_start(res_combo, True, True, 0)
        box.pack_start(res_box, False, False, 0)

        # Auto-start
        auto_check = Gtk.CheckButton(label="Auto-start on boot")
        auto_check.set_active(autostart)
        box.pack_start(auto_check, False, False, 0)

        dialog.show_all()
        response = dialog.run()

        if response == Gtk.ResponseType.OK:
            new_res = "1080p" if res_combo.get_active() == 1 else "720p"
            new_autostart = auto_check.get_active()

            if new_res != current_res:
                w, h = ("1920", "1080") if new_res == "1080p" else ("1280", "720")
                sed_cmd = f"s/width=[0-9]\\+,height=[0-9]\\+/width={w},height={h}/g"
                subprocess.run([
                    "pkexec", "bash", "-c",
                    f"sed -i '{sed_cmd}' '{SERVICE_FILE}' && systemctl daemon-reload"
                ])
                if is_active():
                    subprocess.Popen(["pkexec", "systemctl", "restart", SERVICE])
                self._notify(f"Resolution changed to {w}\u00d7{h}.")

            if new_autostart and not autostart:
                subprocess.run(["pkexec", "systemctl", "enable", SERVICE])
                self._notify("Auto-start enabled.")
            elif not new_autostart and autostart:
                subprocess.run(["pkexec", "systemctl", "disable", SERVICE])
                self._notify("Auto-start disabled.")

            GLib.timeout_add(2000, self._update_icon)

        dialog.destroy()

    def _on_status(self, _):
        lines = []

        _, svc = run(["systemctl", "is-active", SERVICE])
        lines.append(f"Service:     {svc}")

        _, enb = run(["systemctl", "is-enabled", SERVICE])
        lines.append(f"Auto-start:  {enb}")

        lines.append(f"Resolution:  {get_current_resolution()}")
        lines.append("")

        lines.append("--- PipeWire Video ---")
        rc, wpctl = run(["wpctl", "status"])
        if rc == 0:
            capture = False
            for line in wpctl.splitlines():
                if "Video" in line:
                    capture = True
                if capture:
                    lines.append(line)
                    if line.strip() == "" and capture:
                        break
        else:
            lines.append("(wpctl not available)")

        lines.append("")
        lines.append("--- Camera Portal ---")
        rc, portal = run([
            "busctl", "--user", "get-property",
            "org.freedesktop.portal.Desktop",
            "/org/freedesktop/portal/desktop",
            "org.freedesktop.portal.Camera",
            "IsCameraPresent",
        ])
        lines.append(f"IsCameraPresent: {portal if rc == 0 else '(portal not available)'}")

        dialog = Gtk.Dialog(title="IPU6 Camera Status")
        dialog.add_buttons(Gtk.STOCK_CLOSE, Gtk.ResponseType.CLOSE)
        dialog.set_default_size(520, 400)
        dialog.set_icon_name(ICON_ON)

        scroll = Gtk.ScrolledWindow()
        scroll.set_policy(Gtk.PolicyType.AUTOMATIC, Gtk.PolicyType.AUTOMATIC)

        textview = Gtk.TextView()
        textview.set_editable(False)
        textview.set_monospace(True)
        textview.set_left_margin(12)
        textview.set_top_margin(8)
        textview.get_buffer().set_text("\n".join(lines))

        scroll.add(textview)
        dialog.get_content_area().pack_start(scroll, True, True, 0)

        dialog.show_all()
        dialog.run()
        dialog.destroy()

    def _on_quit(self, _):
        Gtk.main_quit()

    def _notify(self, message):
        subprocess.Popen([
            "notify-send", "IPU6 Camera", message, "-i", ICON_ON,
        ])


def acquire_lock():
    """Ensure single instance via file lock."""
    try:
        fd = open(LOCK_PATH, "w")
        fcntl.flock(fd, fcntl.LOCK_EX | fcntl.LOCK_NB)
        return fd
    except OSError:
        subprocess.run([
            "notify-send", "IPU6 Camera",
            "Tray utility is already running.", "-i", ICON_ON,
        ])
        sys.exit(0)


def main():
    lock_fd = acquire_lock()
    try:
        CameraTray()
        Gtk.main()
    finally:
        lock_fd.close()
        try:
            os.unlink(LOCK_PATH)
        except OSError:
            pass


if __name__ == "__main__":
    main()
